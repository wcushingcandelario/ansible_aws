---

#- name: This play will install the ami-builder and mongo cluster

- name: Install RDS
  roles:
    - create_rds
  tags:
    - rds
  vars:
    environment_name: prod-util-rds
    rds_security_group: sg-be2081d9
    rds_subnet_group: prod-util-rds
    multirdszone: yes

- name: Install Mongo Cluster
  include: mongo-cluster.yml
  remote_user: ec2-user
  tags:
    - mongo
  vars:
   region: eu-west-1
   key: ovc-travis
 #  ovc_security_groups: sg-be2081d9 # FIXME: Wrong
 #  vpc_subnet_public: subnet-1d719879 # FIXME: Wrong
   ovc_security_groups: sg-5bbc1f3c # Temp for testing
   vpc_subnet_public: subnet-0a75a06e # Temp for testing
   instance_type: m4.large
   env: prod.ovchosting.co.uk
   cluster_name: prod_cluster
   deploy_type: "prod"

- name: install ami-builder
  include: ami-baker.yml
  tags:
    - bake_ami
  vars:
    ovc_version: "5.4.0"
    region: eu-west-1
    key: ovc-travis
#    ovc_security_group: sg-71bc1f16  #FIXME
    ovc_security_groups: sg-71bc1f16 # Temp for testing
    instance_type: m4.large
    asg_name: "Prod_autoscale"
    vpc_subnet_public: subnet-bc9790e5 #FIXME
    vpc_subnet_public: subnet-cae8ffbd # Temp for testing
    deploy_pos: "Prod-POS"
    deploy_dash: "Prod-Dash"
    deploy_type: "prod"
    jetty_user_login: jetty
    jetty_dir: /opt/jetty
    ovc_server_user_dir: /opt/ovc
    webserver_user: www-data
    s3install: true
    asg_desired_capacity: 2

- name: Install ELB and ASG
  include: asg_main.yml
  tags:
    - asg
  vars:
    IAMROLE: "CodeDeploy-EC2"
    region: eu-west-1
    key: ovc-travis
    ovc_version: "5.4.0"
#    ovc_security_groups: ['sg-b12180d6'] #FIXME
    ovc_security_groups: ['sg-71bc1f16'] # Temp for testing
    deploy_pos: "Prod-POS"
    deploy_dash: "Prod-Dash"
    deploy_type: "prod"
    instance_type_asg: m4.xlarge
    security_group_ids: "sg-887dc9ef,sg-9fbd1ef8,sg-71bc1f16" # Temp for testing
#    elbsubnets: "subnet-0abd536e,subnet-10948367,subnet-354f656c"
    elbsubnets: "subnet-ac2d02f5,subnet-cae8ffbd,subnet-d4a14fb0" # Temp for testing
