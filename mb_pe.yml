---
 - hosts: localhost
   tasks:
    - name: Creating Beanstalk application
      elasticbeanstalk_app:
         region: us-east-1
         app_name: MB-Promo
         description: MB Promo Engine
         state: present
      register: application

    - debug: var=application

    - name: Versioning the application
      elasticbeanstalk_version:
         region: us-east-1
         app_name: MB-Promo
         version_label: 1.5.0
         s3_bucket: ovc-devops
         s3_key: Dockerrun.aws.json.zip
         state: present
      register: version

    - debug: var=version

    - name: Create new Beanstalk environment
      elasticbeanstalk_env:
         region: us-east-1
         app_name: MB-Promo
         env_name: MBPromo
         tier_name: WebServer
         version_label: 1.5.0
         solution_stack_name: "64bit Amazon Linux 2016.09 v2.2.0 running Multi-container Docker 1.11.2 (Generic)"
         option_settings:
           - Namespace: aws:elb:loadbalancer
             OptionName: CrossZone
             Value: true
           - Namespace: aws:elasticbeanstalk:application
             OptionName: Application Healthcheck URL
             Value: TCP:22
           - Namespace: aws:elb:listener
             OptionName: ListenerEnabled
             Value: false
           - Namespace: aws:elb:listener:3000
             OptionName: ListenerProtocol
             Value: HTTPS
           - Namespace: aws:elb:listener:3000
             OptionName: InstanceProtocol
             Value: HTTP
           - Namespace: aws:elb:listener:3000
             OptionName: InstancePort
             Value: 3000
           - Namespace: aws:elb:listener:3000
             OptionName: SSLCertificateId
             Value: "arn:aws:acm:us-east-1:748109554602:certificate/29bd18b2-2c4a-4581-a1bd-1e265a35d313"
           - Namespace: aws:elb:listener:443
             OptionName: InstanceProtocol
             Value: HTTP
           - Namespace: aws:elb:listener:443
             OptionName: ListenerProtocol
             Value: HTTPS
           - Namespace: aws:elb:listener:443
             OptionName: InstancePort
             Value: 8888
           - Namespace: aws:elb:listener:443
             OptionName: SSLCertificateId
             Value: "arn:aws:acm:us-east-1:748109554602:certificate/29bd18b2-2c4a-4581-a1bd-1e265a35d313"
           - Namespace: aws:elb:policies
             OptionName: LoadBalancerPorts
             Value: 3000, 443
           - Namespace: aws:elb:policies
             OptionName: Stickiness Cookie Expiration
             Value: 300
           - Namespace: aws:autoscaling:asg
             OptionName: MinSize
             Value: 2
           - Namespace: aws:autoscaling:asg
             OptionName: MaxSize
             Value: 5
           - Namespace: aws:elb:loadbalancer
             OptionName: SecurityGroups
             Value: sg-eeecf389, sg-6387e207, sg-6387e207, sg-05ee4c78
           - Namespace: aws:elb:loadbalancer
             OptionName: ManagedSecurityGroup
             Value: sg-05ee4c78
           - Namespace: aws:elasticbeanstalk:environment
             OptionName: ServiceRole
             Value: aws-elasticbeanstalk-service-role
           - Namespace: aws:elasticbeanstalk:environment
             OptionName: EnvironmentType
             Value: LoadBalanced
           - Namespace: aws:ec2:vpc
             OptionName: Subnets
             Value: subnet-9f8a92b7, subnet-a194589c
           - Namespace: aws:ec2:vpc
             OptionName: VPCId
             Value: vpc-ccb0b5a9
           - Namespace: aws:ec2:vpc
             OptionName: ELBSubnets
             Value: subnet-9f8a92b7, subnet-a194589c
           - Namespace: aws:ec2:vpc
             OptionName: ELBScheme
             Value: external
           - Namespace: aws:ec2:vpc
             OptionName: AssociatePublicIpAddress
             Value: true
           - Namespace: aws:autoscaling:launchconfiguration
             OptionName: IamInstanceProfile
             Value: aws-elasticbeanstalk-ec2-role
           - Namespace: aws:autoscaling:launchconfiguration
             OptionName: InstanceType
             Value: t2.medium
           - Namespace: aws:autoscaling:launchconfiguration
             OptionName: SecurityGroups
             Value: sg-eeecf389, sg-6387e207, sg-6387e207
           - Namespace: aws:autoscaling:launchconfiguration
             OptionName: EC2KeyName
             Value: ovc-demo

    - name: Record ELB EndpointURL
      command: "aws elasticbeanstalk describe-environments --query='Environments[?EnvironmentName==`{{ deploy_type }}Promo` && Status==`Ready`].EndpointURL'"
      register: elb_dns

    - name: debug elb dns
      debug: "var=elb_dns"

    - name: Add Alias to Route53
      route53:
        command: "create"
        zone: "ovcdemo.com"
        record: "mb-promo.ovcdemo.com"
        type: "A"
        value: "{{ elb_dns.stdout }}"
        alias: "True"
        alias_hosted_zone_id: "Z35SXDOTRQ7X7K"
        overwrite: yes
      tags:
        - pe_env
